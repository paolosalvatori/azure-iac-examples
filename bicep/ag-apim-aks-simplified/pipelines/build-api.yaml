# build-api.yaml

parameters:
  - name: vmImage
    default: 'ubuntu-latest'
    type: string
  - name: poolName
    default: 'Azure Pipelines'
    type: string
  - name: environment
    type: string
    default: 'dev'
  - name: resourceGroupName
    type: string
  - name: azureConnection
    default: 'internal_azure_subscription'
    type: string
  - name: apiImageName
    type: string
  - name: apiSvcIp
    type: string
  - name: apiName
    type: string
  - name: apiPort
    type: string
stages:
  - stage: Build
    jobs:
    - job: Build_Container
      pool: 
        name: ${{parameters.poolName}}
        vmImage: ${{parameters.vmImage}}
      steps:
        - checkout: self
          clean: true
          persistCredentials: true
          path: /bicep/ag-apim-aks-simplified
        - task: ARM Outputs@6
          inputs:
            ConnectedServiceNameSelector: 'ConnectedServiceNameARM'
            ConnectedServiceNameARM: $(azureConnection)
            resourceGroupName: $(resourceGroupName)
            whenLastDeploymentIsFailed: 'fail'
            deploymentNameFilter: '$(environment)-infra-deployment'
        - task: AzureCLI@2
          displayName: 'build & push container'
          inputs:
            azureSubscription: ${{azureConnection}}
            inlineScript: |
              Write-Host -Object "Bulding container image"
              az acr build `
                -r $(acrName) `
                -t $(acrName).azurecr.io/$(apiImageName) `
                --build-arg SERVICE_PORT=$(apiPort) `
                -f $(System.DefaultWorkingDirectory)/bicep/ag-apim-aks-simplified/src/Dockerfile "$(System.DefaultWorkingDirectory)/bicep/ag-apim-aks-simplified/src/$(apiName)"
            ScriptType: pscore
